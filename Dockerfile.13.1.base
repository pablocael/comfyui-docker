FROM nvidia/cuda:13.0.0-cudnn-runtime-ubuntu24.04
USER root
# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

SHELL ["/bin/bash", "-c"]

# Install ALL system dependencies in one layer and remove ALL apt cache
RUN apt update && apt install -y \
    unzip \
    curl \
    openssh-server \
    wget \
    git \
    build-essential \
    cmake \
    aria2 \
    ffmpeg \
    libgl1 \
    tmux \
    python3-venv \
    python3-pip \
    && apt-get clean autoclean \
    && apt-get autoremove --yes \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /var/lib/{cache,log}/ \
    && rm -rf /var/cache/apt/archives/*.deb

ENV USE_SDXL_MODELS="false" 
ENV USE_WAN_MODELS="false"
ENV USE_QWEN_MODELS="false"
ENV USE_FLUX_MODELS="false"
ENV USE_HV_MODELS="false"

WORKDIR /root

# Create and activate virtual environment
RUN python3 -m venv /root/python-env
ENV PATH="/root/python-env/bin:$PATH"

# Upgrade pip and install base packages
RUN pip3 install --upgrade pip && \
    pip3 install --no-cache pyyaml && \
    pip3 install --no-cache torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu129

# Clone ComfyUI
RUN echo "########################################" && \
    echo "[INFO] Downloading ComfyUI ..." && \
    echo "########################################" && \
    git clone https://github.com/comfyanonymous/ComfyUI.git

# Install ComfyUI dependencies
RUN echo "########################################" && \
    echo "[INFO] Installing ComfyUI Deps..." && \
    echo "########################################" && \
    pip3 install -r /root/ComfyUI/requirements.txt

# Copy runner-scripts requirements if they exist (optional)
# COPY runner-scripts/requirements.txt /runner-scripts/requirements.txt
# RUN pip3 install -r /runner-scripts/requirements.txt

# Change to custom_nodes directory
WORKDIR /root/ComfyUI/custom_nodes

# Install ComfyUI Manager
RUN echo "########################################" && \
    echo "[INFO] Installing ComfyUI Manager..." && \
    echo "########################################" && \
    git clone https://github.com/ltdrdata/ComfyUI-Manager.git

# Configure git for better network handling
RUN git config --global http.timeout 60 && \
    git config --global http.lowSpeedLimit 0 && \
    git config --global http.lowSpeedTime 999999

# Download Custom Nodes
RUN echo "########################################" && \
    echo "[INFO] Downloading Custom Nodes..." && \
    echo "########################################"

# Workspace
RUN git clone https://github.com/crystian/ComfyUI-Crystools.git

# General
RUN git clone https://github.com/bash-j/mikey_nodes.git && \
    git clone https://github.com/chrisgoringe/cg-use-everywhere.git && \
    git clone https://github.com/cubiq/ComfyUI_essentials.git && \
    git clone https://github.com/jags111/efficiency-nodes-comfyui.git && \
    git clone https://github.com/kijai/ComfyUI-KJNodes.git && \
    git clone https://github.com/pythongosssss/ComfyUI-Custom-Scripts.git && \
    git clone https://github.com/rgthree/rgthree-comfy.git && \
    git clone https://github.com/shiimizu/ComfyUI_smZNodes.git && \
    git clone https://github.com/WASasquatch/was-node-suite-comfyui.git && \
    git clone https://github.com/Gourieff/ComfyUI-ReActor.git

# Control
RUN git clone https://github.com/cubiq/ComfyUI_InstantID.git && \
    git clone https://github.com/cubiq/ComfyUI_IPAdapter_plus.git && \
    git clone https://github.com/cubiq/PuLID_ComfyUI.git && \
    git clone https://github.com/Fannovel16/comfyui_controlnet_aux.git && \
    git clone https://github.com/florestefano1975/comfyui-portrait-master.git && \
    git clone https://github.com/huchenlei/ComfyUI-layerdiffuse.git && \
    git clone https://github.com/Kosinkadink/ComfyUI-Advanced-ControlNet.git && \
    git clone https://github.com/ltdrdata/ComfyUI-Impact-Pack.git && \
    git clone https://github.com/ltdrdata/ComfyUI-Impact-Subpack.git && \
    git clone https://github.com/ltdrdata/ComfyUI-Inspire-Pack.git && \
    git clone https://github.com/mcmonkeyprojects/sd-dynamic-thresholding.git && \
    git clone https://github.com/storyicon/comfyui_segment_anything.git && \
    git clone https://github.com/twri/sdxl_prompt_styler.git

# Video
RUN git clone https://github.com/Fannovel16/ComfyUI-Frame-Interpolation.git && \
    git clone https://github.com/FizzleDorf/ComfyUI_FizzNodes.git && \
    git clone https://github.com/Kosinkadink/ComfyUI-AnimateDiff-Evolved.git && \
    git clone https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git && \
    git clone https://github.com/melMass/comfy_mtb.git

# More extensions
RUN git clone https://github.com/cubiq/ComfyUI_FaceAnalysis.git && \
    git clone https://github.com/pythongosssss/ComfyUI-WD14-Tagger.git && \
    git clone https://github.com/SLAPaper/ComfyUI-Image-Selector.git && \
    git clone https://github.com/ssitu/ComfyUI_UltimateSDUpscale.git && \
    git clone https://github.com/M1kep/ComfyLiterals.git && \
    git clone https://github.com/Jonseed/ComfyUI-Detail-Daemon.git && \
    git clone https://github.com/yolain/ComfyUI-Easy-Use.git && \
    git clone https://github.com/aria1th/ComfyUI-LogicUtils.git && \
    git clone https://github.com/ServiceStack/comfy-asset-downloader.git && \
    git clone https://github.com/TTPlanetPig/Comfyui_TTP_Toolset.git && \
    git clone https://github.com/willmiao/ComfyUI-Lora-Manager.git && \
    git clone https://github.com/welltop-cn/ComfyUI-TeaCache.git && \
    git clone https://github.com/kijai/ComfyUI-FramePackWrapper.git && \
    git clone https://github.com/orssorbit/ComfyUI-wanBlockswap.git && \
    git clone https://github.com/shinich39/comfyui-get-meta.git && \
    git clone https://github.com/kijai/ComfyUI-DepthAnythingV2.git && \
    git clone https://github.com/kijai/ComfyUI-WanVideoWrapper.git && \
    git clone https://github.com/christian-byrne/audio-separation-nodes-comfyui.git && \
    git clone https://github.com/SeanScripts/ComfyUI-Unload-Model.git && \
    git clone https://github.com/ShmuelRonen/ComfyUI-VideoUpscale_WithModel.git

# GGUF support
RUN git clone https://github.com/city96/ComfyUI-GGUF.git

# Install dependencies for all custom nodes
RUN echo "########################################" && \
    echo "[INFO] Install Deps..." && \
    echo "########################################" && \
    for dir in /root/ComfyUI/custom_nodes/*/; do \
        if [ -f "${dir}requirements.txt" ]; then \
            echo "Installing requirements for: $dir" && \
            cd "$dir" && \
            pip install -r requirements.txt; \
        fi; \
    done

# Set working directory back to ComfyUI root
WORKDIR /root/ComfyUI

# Expose the default ComfyUI port
EXPOSE 8188

# Set the default command to run ComfyUI
CMD ["python", "main.py", "--listen", "0.0.0.0", "--port", "8188"]
